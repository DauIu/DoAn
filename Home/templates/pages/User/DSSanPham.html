<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    {% extends "layout/layout.html" %}
    {% load static %}
    <style>
        .modal-backdrop {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            z-index: 1040;
            background-color: #000;
        }
    </style>
</head>
<body>
    {% block content %}
    {% load static %}
    <div class="container-fluid page-header mb-5 wow fadeIn" data-wow-delay="0.1s">
        <div class="container d-flex justify-content-end">
            <span class="display-3 mb-3 animated slideInDown" style="font-weight:800; font-size:72px;"> &nbsp; Sản phẩm &nbsp;  </span>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class="bg_collection collection_2">

                <div class="main_container col-lg-12 padding-col-left-0">
                    <div class="category-products products f-left w_100">

                        <div class="sortPagiBar">
                            <div class="row">
                                <div class="col-xs-12 col-sm-12 col-md-4 col-lg-6 mb-3">
                                    <div class="section-header text-start mb-5 wow fadeInUp" data-wow-delay="0.1s" style="max-width: 400px;">
                                        <span style="font-size:22px">Sắp xếp theo: </span>
                                        <ul class="sort-options d-inline-flex justify-content-end">
                                            <li class="btn me-2 price-asc" style="background-color: darkorange">
                                                <a class="text-decoration-none text-dark" href="?q={{ keyword }}&loai={{ ma_loai }}&sort=GiaTang"><i></i>Giá tăng dần</a>
                                            </li>
                                            <li class="btn me-2 price-desc" style="background-color: #3da346">
                                                <a class="text-decoration-none text-dark" href="?q={{ keyword }}&loai={{ ma_loai }}&sort=GiaGiam"><i></i>Giá giảm dần</a>
                                            </li>
                                        </ul>
                                    </div>
                                </div> 
                                <div class="col-xs-12 col-sm-12 col-md-4 col-lg-6 mb-3">
                                    <div class="bg-white sort-cate clearfix">
                                        <div class="section-header text-center mb-5 wow fadeInUp">
                                            <span style="font-size:22px">Tìm kiếm sản phẩm tại đây</span>
                                            <form method="GET" action="">
                                                <div class="input-group mb-3">
                                                    <input type="text" name="q" class="form-control" placeholder="Nhập tên sản phẩm..." value="{{ keyword|default:'' }}">
                                                    <button class="btn btn-success" type="submit"><i class="bi bi-search"></i> Tìm kiếm</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <section class="products-view products-view-grid">
                            {% if dsSanPham %}
                            <div class="row">
                                {% for product in dsSanPham %}
                                <div class="col-xl-4 col-lg-4 col-md-6 wow fadeInUp mb-3" data-wow-delay="0.1s">
                                    <div class="product-item">
                                        <div class="position-relative overflow-hidden">
                                            <img class="img-fluid d-block mx-auto" style="width:250px; height:250px" src="{% static 'products/' %}{{ product.HinhAnh }}" alt="">
                                        </div>
                                        <div class="text-center p-4">
                                            <a class="d-block h5 mb-2 text-decoration-none" href="{% url 'UserMember:chiTietSP' product_id=product.MaSP %}">{{ product.TenSP }}</a>
                                            <span class="text-success me-1">{{ product.GiaBan|floatformat:3 }} VNĐ</span>
                                        </div>
                                        <div class="d-flex border-top">
                                            <small class="w-50 text-center border-end py-2">
                                                <a class="btn btn-outline-light text-body text-decoration-none" href="{% url 'UserMember:chiTietSP' product_id=product.MaSP %}"><i class="fa fa-eye text-success me-2"></i>Xem chi tiết</a>
                                            </small>
                                            <small class="w-50 text-center py-2">
                                                <button type="button" onclick="addToCart(event, '{{ product.MaSP }}')" class="text-body text-decoration-none btn btn-outline-light btn-add-to-cart"{% if product.SoLuongHienTai <= 0 %}disabled{% endif %} >
                                                    <i class="fa fa-shopping-bag text-success me-2"></i>Thêm vào giỏ
                                                </button>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center">
                                <p>Không tìm thấy sản phẩm nào phù hợp với từ khóa "<strong>{{ keyword }}</strong>".</p>
                            </div>
                            {% endif %}

                            <div class="text-center mt-3">
                                <nav class="clearfix nav_pagi f-center w_100">
                                    <ul class="pagination clearfix justify-content-center">
                                        {% if dsSanPham.has_previous %}
                                        <li class="page-item"><a class="page-link" href="?{% if ma_loai %}loai={{ ma_loai }}&{% elif sort %}sort={{ sort }}&{% endif %}page=1"><i class="fas fa-angle-double-left text-success"></i></a></li>
                                        <li class="page-item"><a class="page-link" href="?{% if ma_loai %}loai={{ ma_loai }}&{% elif sort %}sort={{ sort }}&{% endif %}page={{ dsSanPham.previous_page_number }}"><i class="fas fa-angle-left text-success"></i></a></li>
                                        {% else %}
                                        <li class="page-item disabled"><a class="page-link" href="#"><i class="fas fa-angle-left"></i></a></li>
                                        {% endif %}
                                        {% for page_num in dsSanPham.paginator.page_range %}
                                        {% if dsSanPham.number == page_num %}
                                        <li class="page-item active"><a class="page-link bg-success" href="#">{{ page_num }}</a></li>
                                        {% elif page_num > dsSanPham.number|add:'-3' and page_num < dsSanPham.number|add:'3' %}
                                        <li class="page-item"><a class="page-link text-success" href="?{% if ma_loai %}loai={{ ma_loai }}&{% elif sort %}sort={{ sort }}&{% endif %}page={{ page_num }}">{{ page_num }}</a></li>
                                        {% endif %}
                                        {% endfor %}
                                        {% if dsSanPham.has_next %}
                                        <li class="page-item"><a class="page-link" href="?{% if ma_loai %}loai={{ ma_loai }}&{% elif sort %}sort={{ sort }}&{% endif %}page={{ dsSanPham.next_page_number }}"><i class="fas fa-angle-right text-success"></i></a></li>
                                        <li class="page-item"><a class="page-link" href="?{% if ma_loai %}loai={{ ma_loai }}&{% elif sort %}sort={{ sort }}&{% endif %}page={{ dsSanPham.paginator.num_pages }}"><i class="fas fa-angle-double-right text-success"></i></a></li>
                                        {% else %}
                                        <li class="page-item disabled"><a class="page-link" href="#"><i class="fas fa-angle-right"></i></a></li>
                                        {% endif %}
                                    </ul>
                                </nav>
                            </div>

                        </section>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
    function addToCart(event, productId) {
        event.preventDefault();

        fetch('/cart/add/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: new URLSearchParams({
                'variantId': productId,
                'quantity': 1
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`${data.product_name} đã được thêm vào giỏ hàng.`);
            } else if (data.require_login) {
                alert(data.message || "Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng.");
                window.location.href = '/DangNhap/';
            } else {
                alert(data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng.");
        });
    }
    </script>
    {% endblock %}
</body>
</html>