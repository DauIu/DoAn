<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    {% extends "layout/admin.html" %}
    <title>{% block title %}Quản lý Sản Phẩm{% endblock %}</title>
    {% load static %}
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
</head>

<body>
    {% block content %}
    <div class="container-fluid mt-4">
        <!-- Header Section -->
        <div class="row">
            <div class="col-md-10">
                <h2>Danh sách Sản Phẩm</h2>
            </div>
            <div class="col-md-2 text-end">
                <a href="{% url 'UserMember:them_san_pham' %}" class="btn btn-success">+ Thêm Sản Phẩm</a>
            </div>
        </div>

        <!-- Bộ lọc sản phẩm -->
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-4 col-lg-6">
                <select id="loaiSanPham" class="form-select" onchange="filterByLoai()">
                    <option value="" {% if not selected_loai %}selected{% endif %}>Tất cả sản phẩm</option>
                    {% for loai in dsLoai %}
                    <option value="{{ loai.MaLoai }}"
                            {% if selected_loai and loai.MaLoai == selected_loai.MaLoai %}selected{% endif %}>
                        {{ loai.TenLoai }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-xs-12 col-sm-12 col-md-4 col-lg-6">
                <form method="GET" action="">
                    <div class="input-group mb-3">
                        <input type="text" name="q" class="form-control" placeholder="Nhập tên sản phẩm..." value="{{ keyword|default:'' }}">
                        <button class="btn btn-secondary" type="submit"><i class="bi bi-search"></i> Tìm kiếm</button>
                    </div>
                </form>
            </div>
        </div>
       
        <!-- Danh sách sản phẩm -->
        <table class="table table-borderless table-hover mt-3">
            <thead class="table-success">
                <tr>
                    <th class="text-center">Mã SP</th>
                    <th class="text-center">Tên Sản Phẩm</th>
                    <th class="text-center">Hình Ảnh</th>
                    <th class="text-center">Số Lượng</th>
                    <th class="text-center">Giá Bán</th>
                    <th class="text-center">Tính dễ hư</th>
                    <th class="text-center">Loại</th>
                    <th class="text-center">Thao Tác</th>
                </tr>
            </thead>
            <tbody>
                {% if dsSanPham %}
                {% for sp in dsSanPham %}
                <tr>
                    <td class="text-center">{{ sp.MaSP }}</td>
                    <td class="{% if sp.SoLuongHienTai < 5 %} text-danger {% else %} text-dark {% endif %}" style="width: 20%">
                        <strong>{{ sp.TenSP }}</strong>
                    </td>
                    <td class="text-center">
                        <img class="img-fluid" style="max-width: 100px; height: 80px;" src="{% static 'products/' %}{{ sp.HinhAnh }}" alt="{{ sp.TenSP }}">
                    </td>
                    <td class="text-center">{{ sp.SoLuongHienTai }}</td>
                    <td class="text-center">{{ sp.GiaBan }}</td>
                    <td class="text-center">
                        <input type="checkbox" {% if sp.MucDoHu %}checked{% endif %} disabled> Dễ hư
                    </td>
                    <td class="text-center">{{ sp.MaLoai.TenLoai }}</td>
                    <td class="text-center">
                        <button class="btn btn-outline-secondary btn-sm" onclick="openDetailModal('{{ sp.MaSP }}')">Chi Tiết</button>
                        <a href="{% url 'UserMember:sua_san_pham' sp.MaSP %}" class="btn btn-warning btn-sm">Sửa</a>
                        <form action="{% url 'UserMember:xoa_san_pham' sp.MaSP %}" method="post" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm" style="background-color: darkorange" onclick="return confirm('Bạn có chắc chắn muốn xóa sản phẩm này không?');">Xóa</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr class="text-center">
                    <td colspan="7">Không tìm thấy sản phẩm nào phù hợp với từ khóa "<strong>{{ keyword }}</strong>".</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Modal Chi Tiết Sản Phẩm -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-success" id="detailModalLabel">Chi Tiết Sản Phẩm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Mã SP:</strong> <span id="detailMaSP"></span></p>
                    <p><strong>Tên Sản Phẩm:</strong> <span id="detailTenSP"></span></p>
                    <p><strong>Trọng Lượng:</strong> <span id="detailTrongLuong"></span></p>
                    <p><strong>Nguồn Gốc:</strong> <span id="detailNguonGoc"></span></p>
                    <p><strong>Đơn Vị Tính:</strong> <span id="detailDVT"></span></p>
                    <p><strong>Số Lượng:</strong> <span id="detailSoLuong"></span></p>
                    <p><strong>Giá Bán:</strong> <span id="detailGiaBan"></span></p>
                    <p><strong>Bảo Quản:</strong> <span id="detailBaoQuan"></span></p>
                    <p><strong>Hạn Sử Dụng:</strong> <span id="detailHSD"></span></p>
                    <p><strong>Hình Ảnh:</strong> <img id="detailHinhAnh" class="img-fluid" src="" alt="Hình Ảnh"></p>
                    <p><strong>Tình Trạng:</strong> <span id="detailTinhTrang"></span></p>
                    <p><strong>Mô Tả:</strong> <span id="detailMoTa"></span></p>
                    <p><strong>Loại:</strong> <span id="detailMaLoai"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function openDetailModal(MaSP) {
            fetch(`/api/get-san-pham/${MaSP}/`)
                .then(response => {
                    if (!response.ok) throw new Error('API Error');
                    return response.json();
                })
                .then(data => {
                    document.getElementById('detailMaSP').textContent = data.MaSP;
                    document.getElementById('detailTenSP').textContent = data.TenSP;
                    document.getElementById('detailTrongLuong').textContent = data.TrongLuong;
                    document.getElementById('detailNguonGoc').textContent = data.NguonGoc;
                    document.getElementById('detailDVT').textContent = data.DVT.TenDonVi;
                    document.getElementById('detailSoLuong').textContent = data.SoLuongHienTai;
                    document.getElementById('detailGiaBan').textContent = data.GiaBan;
                    document.getElementById('detailBaoQuan').textContent = data.BaoQuan;
                    document.getElementById('detailHSD').textContent = data.HSD.length ?
                        data.HSD.map(hsd => `${hsd.SoLuongTon} - HSD: ${hsd.NgayHetHan}`).join(', ') :
                        "Không có thông tin";
                    document.getElementById('detailHinhAnh').src = data.HinhAnh || '';
                    document.getElementById('detailTinhTrang').textContent = data.TinhTrang ? "Còn Hàng" : "Hết Hàng";
                    document.getElementById('detailMoTa').textContent = data.MoTa || "Không có mô tả";
                    document.getElementById('detailMaLoai').textContent = data.MaLoai.TenLoai;
                    new bootstrap.Modal(document.getElementById('detailModal')).show();
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("Không thể tải thông tin sản phẩm!");
                });
        }

        function filterByLoai() {
            const loaiSanPham = document.getElementById('loaiSanPham').value;
            const url = "{% url 'UserMember:QLSanPham' %}" + (loaiSanPham ? `?loai=${loaiSanPham}` : '');
            window.location.href = url;
        }
    </script>
    {% endblock %}
</body>

</html>
